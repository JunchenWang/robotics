%目标进行RCM不动点运动，采集目标上的固连坐标的欧拉角和原点
%欧拉角zyx 1 2 3 平移xyz 4 5 6
% data=[
% 
% 60.450185	-58.894022	-171.1190267	-69.671	-68.883	-1413.985
% 60.845887	-59.0075025	-171.537033	-70.453	-68.826	-1413.914
% 61.2880007	-59.1674076	-171.9991069	-71.46	-68.8	-1413.759
% 61.7588727	-59.2776875	-172.4950394	-72.369	-68.852	-1413.603
% 62.0714616	-59.3764156	-172.8390431	-73.387	-68.805	-1413.465
% 62.556016	-59.4998672	-173.353084	-74.332	-68.738	-1413.365
% 63.078706	-59.6492256	-173.9014847	-75.45	-68.692	-1413.215
% 63.4805117	-59.7833625	-174.335923	-76.404	-68.81	-1413.039
% 63.9542938	-59.9143618	-174.8388164	-77.395	-68.823	-1412.968
% 64.3562808	-60.0619783	-175.2693013	-78.462	-68.711	-1412.927
% 64.8644811	-60.1923262	-175.8063824	-79.689	-68.778	-1412.658
% 65.3318366	-60.2977422	-176.307999	-80.35	-68.885	-1412.593
% 65.7954568	-60.4059111	-176.7990552	-81.543	-68.764	-1412.566
% 66.2672513	-60.5284667	-177.2946459	-82.654	-68.62	-1412.502
% 66.8201275	-60.6158342	-177.8783369	-83.593	-68.654	-1412.373
% 67.3116032	-60.7584361	-178.4036635	-84.621	-68.782	-1412.281
% 67.753448	-60.8894906	-178.8781767	-85.842	-68.839	-1412.16
% 68.2633679	-60.9685893	-179.4142149	-86.614	-68.676	-1412.175
% 68.7566822	-61.0867776	-179.9445681	-87.771	-68.705	-1412.035
% 69.3258527	-61.1799732	179.4609748	-88.779	-68.727	-1411.994
% 69.8638155	-61.3150591	178.8883049	-90.108	-68.717	-1411.91
% 70.4148493	-61.436978	178.3176505	-90.902	-68.669	-1411.955
% 70.8835582	-61.5273066	177.8203291	-91.93	-68.815	-1411.825
% 71.5126997	-61.6634681	177.1512248	-93.229	-68.916	-1411.711
% 71.9781918	-61.7054805	176.6551617	-94.323	-68.761	-1411.731
% 72.55448	-61.831545	176.0465963	-95.371	-68.801	-1411.724
% 73.1330182	-61.9183782	175.44061	-96.3	-68.868	-1411.727
% 73.7401843	-62.0034136	174.785198	-97.609	-68.904	-1411.566
% 74.2717519	-62.0696148	174.2348153	-98.492	-68.776	-1411.635
% 74.7302736	-62.1319928	173.7476364	-99.584	-68.832	-1411.624
% 75.3601194	-62.2480898	173.0798609	-100.749	-68.987	-1411.567
% 75.8186955	-62.3321777	172.5906049	-101.552	-68.944	-1411.59
% 76.4122102	-62.3749793	171.9765355	-102.674	-68.862	-1411.627
% 77.0725465	-62.435632	171.287442	-103.886	-68.948	-1411.566
% 77.5743283	-62.5347826	170.7344147	-104.823	-69.093	-1411.528
% 78.1569953	-62.5982958	170.1308258	-105.755	-68.979	-1411.635
% 78.7683725	-62.630022	169.4958242	-107.144	-68.968	-1411.619
% 79.145739	-62.735047	169.0821514	-107.684	-69.119	-1411.697
% 79.7486006	-62.7749215	168.4532725	-108.613	-69.149	-1411.719
% 80.4577022	-62.8340324	167.7101495	-109.948	-69.053	-1411.79
% 81.1961661	-62.8880772	166.941316	-111.235	-69.164	-1411.743
% 81.7374065	-62.9422943	166.3756634	-112.154	-69.287	-1411.766
% 82.1861746	-62.9696477	165.908904	-113.044	-69.149	-1411.924
% 82.8209704	-63.0288581	165.2416025	-114.088	-69.156	-1412.041
% 83.3402077	-63.0733755	164.6739733	-115.207	-69.329	-1411.988
% 83.9463575	-63.130575	164.0399557	-116.289	-69.487	-1411.92
% 84.4475477	-63.1740912	163.5171218	-117.155	-69.371	-1412.202
% 85.1426921	-63.1764457	162.791192	-118.34	-69.26	-1412.334
% 85.5953741	-63.1807409	162.303301	-119.082	-69.379	-1412.327
% 86.1405043	-63.2348744	161.724849	-120.157	-69.434	-1412.383
% 86.7768414	-63.2298281	161.0641172	-121.34	-69.318	-1412.575
% 87.4064387	-63.2638864	160.4020404	-122.285	-69.392	-1412.673
% 87.9570381	-63.3000321	159.8095814	-123.196	-69.518	-1412.705
% 88.5219228	-63.3202176	159.2225018	-124.076	-69.48	-1412.876
% 88.9875891	-63.3059925	158.7343692	-124.957	-69.444	-1413.019
% 89.6074782	-63.3543776	158.0758818	-126.11	-69.574	-1413.056
% 90.3171379	-63.3248879	157.340393	-127.236	-69.667	-1413.077
% 90.7521913	-63.3148013	156.8805846	-128.08	-69.663	-1413.22
% 91.259915	-63.3438708	156.3377409	-128.931	-69.633	-1413.401
% 91.8613272	-63.3026773	155.7081757	-129.855	-69.727	-1413.545
% 92.5077845	-63.2912586	155.0438421	-131.087	-69.788	-1413.599
% 92.9920415	-63.2815062	154.5322877	-131.949	-69.695	-1413.752
% 93.5088306	-63.2992793	153.9813676	-132.761	-69.735	-1413.975
% 94.1046124	-63.277494	153.3647842	-133.648	-69.808	-1414.106
% 94.5121737	-63.2277501	152.9238364	-134.69	-69.893	-1414.142
% 95.0655631	-63.2607069	152.3524156	-135.605	-69.835	-1414.41
% 95.5951208	-63.2343248	151.7901208	-136.286	-69.914	-1414.501
% 96.0867844	-63.2243129	151.2776165	-137.221	-70.011	-1414.63
% 96.5537063	-63.2168336	150.7776124	-138.229	-70.281	-1414.687
% 97.1857551	-63.328382	150.127834	-138.899	-70.677	-1414.791
% 97.6343142	-63.4530357	149.6524518	-139.739	-70.956	-1414.891
% 98.2054363	-63.6084604	149.0549441	-140.605	-71.735	-1414.863
% 98.6870117	-63.6891494	148.539158	-141.404	-72.309	-1414.852
% 99.3243559	-63.7909311	147.884094	-142.275	-72.716	-1414.918
% 99.7964642	-63.9275871	147.3968655	-142.92	-73.371	-1414.934
% 100.3035387	-64.0739629	146.8718997	-143.742	-74.224	-1414.963
% 100.9072641	-64.2153546	146.2376938	-144.825	-74.704	-1415.029
% 101.5038194	-64.3128754	145.6203378	-145.513	-75.383	-1415.043
% 101.9121455	-64.4861442	145.1986868	-146.107	-75.935	-1415.106
% 102.5684868	-64.5937549	144.5230774	-146.926	-76.394	-1415.153
% 103.1050233	-64.6406281	143.9846538	-147.812	-76.826	-1415.287
% 103.4792115	-64.7367383	143.5899464	-148.176	-77.523	-1415.299
% 103.9792076	-64.880061	143.0709508	-148.708	-78.266	-1415.257
% 104.5629161	-64.9723367	142.4772554	-149.686	-78.646	-1415.313
% 105.1669269	-65.094161	141.8627656	-150.404	-79.329	-1415.384
% 105.6582899	-65.2470423	141.3624001	-150.999	-80.128	-1415.394
% 106.1880618	-65.3899796	140.8149786	-151.682	-80.637	-1415.507
% 106.685945	-65.4264379	140.320834	-152.391	-81.094	-1415.598
% 107.1992619	-65.5365681	139.7862495	-152.993	-81.85	-1415.573
% 107.7032118	-65.6952941	139.2773445	-153.466	-82.611	-1415.565
% 108.1675358	-65.8008369	138.8035955	-154.118	-82.903	-1415.698
% 108.6467124	-65.8899261	138.3213495	-154.767	-83.499	-1415.769
% 109.1806451	-65.9995632	137.7831723	-155.326	-84.453	-1415.78
% 109.670183	-66.0741963	137.2839508	-155.981	-84.99	-1415.795
% 110.1860874	-66.2106539	136.7521937	-156.644	-85.541	-1415.858
% 110.7769372	-66.3160986	136.176825	-157.164	-86.011	-1415.984
% 110.9599088	-66.3807116	135.9970909	-157.052	-86.399	-1415.986
% 111.4461833	-66.469386	135.5096495	-157.719	-87.172	-1415.985
% 111.962827	-66.5741265	134.9883209	-158.385	-87.769	-1416.033
% 112.5554068	-66.6488757	134.3983624	-159.014	-88.332	-1416.079
% 112.8908369	-66.7932216	134.0619554	-159.061	-89.116	-1416.083
% 113.1194094	-66.9016971	133.8310263	-159.373	-89.446	-1416.214
% 113.5966399	-66.9788893	133.3518645	-160.058	-90.027	-1416.221
% 114.0711804	-67.0997506	132.8788836	-160.492	-90.644	-1416.188
% 114.5493122	-67.2449604	132.4095301	-160.764	-91.242	-1416.273
% 115.0547271	-67.3326928	131.8971555	-161.301	-91.748	-1416.41
% 115.5484917	-67.387078	131.417433	-161.695	-92.46	-1416.41
% 115.7695524	-67.5401957	131.1942859	-161.722	-93.151	-1416.281
% 116.1733221	-67.6829501	130.8016746	-162.071	-93.797	-1416.401
% 116.5065402	-67.7462182	130.4776746	-162.451	-94.101	-1416.541
% 116.8541788	-67.8571878	130.1336013	-162.615	-94.721	-1416.499
% 117.2695243	-67.9438209	129.72069	-162.916	-95.462	-1416.312
% 117.831011	-68.0905529	129.1723834	-163.403	-96.033	-1416.538
% 118.0332244	-68.1880208	128.9733285	-163.531	-96.405	-1416.517
% 118.3676554	-68.2825268	128.6515356	-163.615	-97.107	-1416.45
% 118.6984182	-68.3798714	128.3197589	-163.948	-97.835	-1416.363
% 118.992568	-68.5068277	128.0379413	-164.044	-98.287	-1416.502
% 119.4227598	-68.5899254	127.6363063	-164.375	-98.632	-1416.604
% 119.6490871	-68.7665599	127.4007169	-164.257	-99.539	-1416.387
% 119.9979629	-68.8448869	127.0627895	-164.647	-100.206	-1416.389
% 120.3813477	-68.9403331	126.7039431	-164.936	-100.381	-1416.517
% 120.602297	-69.061519	126.48993	-164.812	-101.004	-1416.434
% 120.9939837	-69.2384079	126.0957212	-164.884	-101.906	-1416.349
% 121.1995504	-69.3404273	125.9030462	-165.076	-102.168	-1416.335
% 121.5080354	-69.4382415	125.6150086	-165.06	-102.682	-1416.448
% 121.796038	-69.548019	125.3426212	-165.15	-103.541	-1416.35
% 121.9900645	-69.6975684	125.1459365	-165.239	-104.128	-1416.215
% 122.3460977	-69.8031473	124.810268	-165.215	-104.385	-1416.261
% 122.5990165	-69.9298735	124.5698605	-165.229	-104.913	-1416.347
% 122.7707548	-70.1113403	124.4101303	-165.063	-105.654	-1416.235
% 123.1270503	-70.2303908	124.0591343	-165.122	-106.409	-1416.085
% 123.3412226	-70.3581662	123.8481766	-165.134	-106.74	-1416.129
% 123.5386762	-70.481478	123.675923	-165.136	-107.472	-1416.117
% 123.8668059	-70.6790381	123.3600338	-165.05	-108.245	-1416.01
% 124.0731735	-70.7966655	123.1583784	-165.057	-108.494	-1415.891
% 124.0910142	-70.8574282	123.1641054	-164.956	-108.652	-1415.844
% 124.2657113	-71.0443359	122.9940192	-164.702	-109.631	-1415.825
% 124.5997263	-71.2212944	122.6675893	-164.813	-110.456	-1415.634
% 124.7023198	-71.3354377	122.579147	-164.642	-110.616	-1415.598
% 124.909978	-71.5212247	122.3883602	-164.319	-111.169	-1415.704
% 125.0450256	-71.7356829	122.2674647	-164.091	-112.193	-1415.538
% 125.1764932	-71.8679695	122.1480848	-163.955	-112.487	-1415.345
% 125.2968796	-71.980634	122.0371798	-163.863	-112.689	-1415.298
% 125.2067714	-72.1750042	122.1358498	-163.449	-113.511	-1415.248
% 125.4114464	-72.3412148	121.9368469	-163.298	-114.288	-1415.071
% 125.6792792	-72.5011255	121.6823292	-163.257	-114.696	-1414.972
% 125.6822481	-72.6772413	121.696658	-162.827	-115.063	-1414.993
% 125.6955629	-72.8359735	121.7014569	-162.368	-115.698	-1414.914
% 125.8933487	-72.9800849	121.5086007	-162.172	-116.417	-1414.665
% 125.8822966	-73.1643981	121.5330402	-161.834	-116.845	-1414.492
% 125.8861638	-73.3138735	121.5381782	-161.489	-117.13	-1414.495
% 125.9250717	-73.5105251	121.5070012	-161.026	-117.85	-1414.404
% 126.1475152	-73.7168131	121.2892714	-160.677	-118.607	-1414.224
% 126.060313	-73.8950548	121.3924281	-160.52	-118.924	-1414.142
% 125.922868	-74.1274913	121.5333283	-160.014	-119.424	-1413.991
% 126.0216135	-74.3080186	121.4427577	-159.433	-120.229	-1413.866
% 125.9445609	-74.4892885	121.5322779	-158.93	-120.776	-1413.707
% 125.8718541	-74.7014771	121.6180994	-158.502	-121.122	-1413.684
% 125.9453873	-74.8455251	121.559348	-158.235	-121.6	-1413.523
% 125.8255042	-75.1158029	121.6796875	-157.698	-122.312	-1413.362
% 125.527913	-75.344707	121.976257	-157.089	-122.918	-1413.175
% 125.4473009	-75.5717338	122.0592891	-156.631	-123.475	-1413.002
% 125.4490075	-75.7826674	122.0674763	-156.004	-124.189	-1412.879
% 125.3073884	-75.9982994	122.2148654	-155.359	-124.662	-1412.694
% 125.0302537	-76.1906056	122.5075109	-154.785	-125.13	-1412.661
% 124.9739993	-76.3352516	122.5631463	-154.525	-125.249	-1412.627
% 124.856962	-76.5364244	122.6826867	-153.97	-125.897	-1412.454
% 124.798682	-76.7866162	122.7490511	-153.411	-126.734	-1412.289
% 124.2768231	-77.0429216	123.2697494	-152.555	-127.166	-1412.118
% 124.1456488	-77.2403585	123.4017137	-152.031	-127.489	-1412.043
% 124.0009023	-77.4835262	123.5469969	-151.511	-128.409	-1411.839
% 123.5857912	-77.7104418	123.9596994	-150.839	-128.762	-1411.659
% 123.1442419	-77.904522	124.4056283	-150.236	-129.073	-1411.672
% 123.2189656	-78.0984729	124.3203985	-149.887	-129.781	-1411.479
% 122.7008203	-78.3217785	124.8371767	-149.131	-130.225	-1411.233
% 122.1632122	-78.5646222	125.3904518	-148.358	-130.704	-1411.21
% 121.7223601	-78.8258859	125.8230816	-147.392	-131.438	-1411.161
% 121.3407777	-79.1149669	126.1913484	-146.662	-131.953	-1410.988
% 120.7006962	-79.3329337	126.8214579	-146.19	-132.139	-1410.641
% 119.9919461	-79.5551584	127.5281252	-145.271	-132.881	-1410.589
% 119.4578684	-79.8133389	128.0602359	-144.364	-133.792	-1410.626
% 118.9710083	-80.0510382	128.543228	-143.811	-134.004	-1410.439
% 118.2216613	-80.2638639	129.2847253	-143.087	-134.139	-1410.238
% 117.3932161	-80.4785546	130.1098728	-142.394	-135.003	-1410.167
% 116.6848957	-80.7935837	130.8018694	-141.446	-136.015	-1410.118
% 115.7675636	-80.9877064	131.7210112	-140.763	-135.943	-1409.904
% 114.9246985	-81.2224956	132.5539853	-139.843	-136.455	-1409.845
% 113.979962	-81.4494604	133.4890833	-139.263	-137.218	-1409.738
% 113.0228229	-81.6742948	134.4302231	-138.527	-137.858	-1409.605
% 111.621493	-81.9243747	135.8239438	-137.435	-137.787	-1409.518
% 110.013227	-82.0286862	137.4185082	-136.586	-137.941	-1409.387
% 108.4163344	-82.1712813	139.0055777	-135.735	-138.359	-1409.27
% 107.0768054	-82.242358	140.332886	-134.925	-138.526	-1408.948
% 105.3906746	-82.3115242	142.0122687	-134.123	-138.286	-1408.885
% 103.4950929	-82.3775753	143.8991489	-133.012	-138.397	-1408.833
% 101.4597672	-82.4470385	145.9196772	-132.09	-138.508	-1408.714
% 99.9340887	-82.4931038	147.415566	-131.54	-138.384	-1408.47
% 97.7013017	-82.5591247	149.6273969	-130.674	-138.417	-1408.383
% 95.158361	-82.5926082	152.1464588	-129.4	-138.47	-1408.352
% 93.6960556	-82.5798512	153.6061294	-128.492	-138.285	-1408.191
% 92.0438287	-82.5916795	155.2382637	-127.926	-138.204	-1407.912
% 
% 
% 
% 
% ]

% cube position
% data=[
% 7.3495412	-65.3505506	-121.1331622	49.792	-156.599	-1417.984
% -167.758647	-84.5399072	55.0140439	-62.298	-173.785	-1420.477
% -72.5588678	-64.0126411	-42.0577086	-17.358	-254.451	-1454.095
% 66.7150166	-64.5583421	-174.3375346	1.473	-86.583	-1412.96
% 147.4617527	-82.7100123	103.0192861	-67.717	-148.475	-1334.328
% 8.3353005	-64.1905281	-119.5156163	92.684	-147.71	-1345.048
% 74.2287267	-55.2240601	178.7231551	19.599	3.234	-1339.465
% -53.9777497	-72.5411016	-56.6290595	17.432	-253.653	-1341.288
%     ];

% data=[
%     60.2472102	-66.3325367	-171.7536626	5.689	-92.136	-1421.816					
% -45.2202605	-74.1247131	-69.5549501	-7.262	-206.123	-1461.933					
% 25.6392519	-68.681539	-136.9632417	45.694	-139.509	-1380.952
% 
% -45.2202605	-74.1247131	-69.5549501	-7.262	-206.123	-1461.933					
% 25.6392519	-68.681539	-136.9632417	45.694	-139.509	-1380.952
%  60.2472102	-66.3325367	-171.7536626	5.689	-92.136	-1421.816
%     ];

data = simulatedRCM();
data=[0 0 0 0 0 0;data];
% data = [13.0402169	-81.2853935	-127.9322908	-14.023	-74.06	-1426.874
% 25.7584105	-80.6529849	-140.4559064	-13.69	-73.667	-1425.427
% 42.5354419	-78.8084962	-156.9108052	-13.453	-72.843	-1422.951
% 53.6853129	-76.2763945	-167.7359676	-13.262	-71.953	-1420.385
% 60.9350101	-73.2866825	-174.6618362	-12.756	-70.772	-1417.982
% 66.1420928	-70.1503789	-179.5370014	-12.36	-69.472	-1415.522
% 69.8201704	-66.9436564	177.0968107	-11.917	-68.287	-1413.169
% 72.6013234	-63.5178006	174.6491485	-11.518	-66.582	-1410.936
% 74.7892541	-60.1004037	172.7733661	-11.116	-64.921	-1408.676
% 75.9652776	-57.9688298	171.8306519	-10.485	-63.656	-1407.618
% 76.004062	-57.9609787	171.7830418	-10.6	-63.721	-1407.53
% 
% 	];
 
[dataSizeA, ~] = size(data);


%计算旋量
pointAndUaxis = zeros(dataSizeA-1,8);
for i = 1:dataSizeA-1
pointAndUaxis(i,:) = rot2sm(data(i+1,:), data(1,:));

end

%最小二乘法计算trocarPoint
points = pointAndUaxis(:,1:3);
vectors = pointAndUaxis(:,4:6);

left = zeros(3,3);
right = zeros(3,1);
for i = 1:size(points,1)
    p = points(i,:);
    v = vectors(i,:);
    % x偏导数为零
   left(1,1) = left(1,1) +1/v(1)-v(1);
   left(1,2) = left(1,2) -v(2);
   left(1,3) = left(1,3) -v(3);
   right(1,1) = right(1,1) + p(1)/v(1) - p(1) * v(1) - p(2)*v(2) - p(3)*v(3);
   % y偏导数为零
   left(2,1) = left(2,1) -v(1);
   left(2,2) = left(2,2) +1/v(2) -v(2);
   left(2,3) = left(2,3) -v(3);
   right(2,1) = right(2,1) + p(2)/v(2) - p(1) * v(1) - p(2)*v(2) - p(3)*v(3);
   % z偏导数为零
   left(3,1) = left(3,1) -v(1);
   left(3,2) = left(3,2) -v(2);
   left(3,3) = left(3,3) +1/v(3)-v(3);
   right(3,1) = right(3,1) + p(3)/v(3) - p(1) * v(1) - p(2)*v(2) - p(3)*v(3);
   
end

%三元一次方程计算
trocarPoint = left\right;
%计算trocarPoint到各个旋量轴距离，求平均值
trocarPointDistance = zeros(size(points,1), 1);
for i = 1: size(points,1)
trocarPointDistance(i,1) = calcpointDistanceToLine(trocarPoint' , points(i,:),vectors(i,:));

end

trocarPointError = mean(trocarPointDistance);

% 欧拉角转为旋转矩阵加上平移
function T = rot2t(data)
    
zyx = data(1:3);
%zyx = zyx/180*pi;
t = data(4:6);
t= t';

R = eul2rotm(zyx,'zyx');

T = [R,t;0 0 0 1];
end
%求两个位姿的旋量
function sm = rot2sm(data1, data2)

T1 = rot2t(data1);
T2 = rot2t(data2);
T =T1*InvertT(T2);
twist = logT(T);
plot_twist(twist)

sm = twist2sm(twist);
end

%trocar 点到旋量轴的距离
function d = calcpointDistanceToLine(point, linePoint,lineVector)
    p2p = point -linePoint;
    tmp = cross(p2p, lineVector);
    d = norm(tmp);
   
end