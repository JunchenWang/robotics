%目标进行RCM不动点运动，采集目标上的固连坐标的欧拉角和原点
%欧拉角zyx 1 2 3 平移xyz 4 5 6
% data=[
% 13.034921	-81.287044	-127.926973	-14.035	-74.063	-1426.902
% 12.8912557	-81.290121	-127.7805599	-14.034	-74.076	-1426.902
% 12.926112	-81.2883603	-127.820911	-14.028	-74.06	-1426.907
% 13.045358	-81.2846784	-127.9375895	-14.024	-74.058	-1426.899
% 12.9730101	-81.3041015	-127.865739	-14.013	-74.069	-1426.904
% 13.0363334	-81.2712027	-127.9292477	-14.005	-74.066	-1426.887
% 12.9432865	-81.2835733	-127.835206	-14.016	-74.056	-1426.897
% 12.9941978	-81.2904896	-127.8842976	-14.016	-74.061	-1426.906
% 12.8724254	-81.2702671	-127.7641648	-14.023	-74.064	-1426.894
% 13.035425	-81.2645423	-127.9286343	-14.028	-74.063	-1426.873
% 13.0334035	-81.2921199	-127.922913	-14.037	-74.064	-1426.886
% 13.0053686	-81.2909644	-127.8948434	-14.037	-74.06	-1426.893
% 12.939564	-81.2755295	-127.8276971	-14.013	-74.067	-1426.879
% 12.9601429	-81.2828449	-127.8532593	-14.018	-74.068	-1426.877
% 12.8916107	-81.286901	-127.7828513	-14.012	-74.061	-1426.91
% 12.8539156	-81.2874441	-127.7504354	-14.021	-74.06	-1426.895
% 12.9355211	-81.2729989	-127.8281271	-14.02	-74.069	-1426.888
% 13.1300164	-81.2962909	-128.0242203	-14.032	-74.059	-1426.877
% 12.8258337	-81.2783898	-127.7156381	-14.034	-74.056	-1426.901
% 12.9979149	-81.2723743	-127.8892809	-14.026	-74.069	-1426.882
% 13.0010157	-81.2825524	-127.8916864	-14.029	-74.065	-1426.886
% 12.9479368	-81.2797041	-127.8395342	-14.023	-74.059	-1426.895
% 13.0160429	-81.2809158	-127.9086886	-14.023	-74.061	-1426.871
% 12.9017837	-81.2893429	-127.7941788	-14.016	-74.067	-1426.902
% 13.0416157	-81.2735065	-127.9331331	-14.02	-74.061	-1426.873
% 12.8660051	-81.2976134	-127.7560182	-14.031	-74.061	-1426.903
% 12.9756612	-81.282896	-127.8682299	-14.027	-74.068	-1426.895
% 12.9528738	-81.2801302	-127.8472728	-14.033	-74.066	-1426.888
% 12.8419535	-81.2715035	-127.7370703	-14.033	-74.059	-1426.91
% 13.0113304	-81.2798473	-127.9044883	-14.02	-74.061	-1426.883
% 13.1118246	-81.2810204	-128.0028227	-14.012	-74.064	-1426.877
% 12.8817823	-81.2790023	-127.7753904	-14.012	-74.062	-1426.899
% 12.9875918	-81.2997195	-127.8794164	-14.029	-74.055	-1426.892
% 13.1106412	-81.2947718	-128.0015427	-14.028	-74.062	-1426.871
% 13.0037075	-81.3032891	-127.8955259	-14.035	-74.063	-1426.883
% 13.0452221	-81.2851411	-127.9365862	-14.035	-74.06	-1426.885
% 13.0402169	-81.2853935	-127.9322908	-14.023	-74.06	-1426.874
% 12.9286618	-81.2779573	-127.81933	-14.027	-74.059	-1426.88
% 12.9570785	-81.262071	-127.8475241	-14.016	-74.063	-1426.893
% 13.007705	-81.2964736	-127.898778	-14.017	-74.052	-1426.887
% 13.6903344	-81.2626095	-128.5590729	-14.014	-73.513	-1426.805
% 15.1635635	-81.2411651	-130.0167084	-14.282	-73.249	-1426.625
% 17.1162944	-81.1475275	-131.9407057	-14.218	-73.66	-1426.393
% 19.0045525	-81.0547888	-133.8011821	-14.049	-74.246	-1426.205
% 21.4792094	-80.9649271	-136.2432011	-14.078	-73.804	-1425.94
% 23.695168	-80.8077799	-138.4141703	-14.119	-73.538	-1425.663
% 25.7584105	-80.6529849	-140.4559064	-13.69	-73.667	-1425.427
% 27.6701875	-80.549918	-142.3373692	-13.818	-73.69	-1425.131
% 29.7850183	-80.3941295	-144.4183254	-13.956	-73.423	-1424.913
% 31.4119388	-80.2252459	-146.0135848	-13.671	-73.485	-1424.704
% 33.1211866	-79.9825746	-147.6805733	-13.637	-73.375	-1424.397
% 34.7509155	-79.8362167	-149.2816373	-13.692	-73.287	-1424.103
% 36.790501	-79.6549347	-151.2900198	-13.765	-73.064	-1423.912
% 37.9974157	-79.4204493	-152.467335	-13.692	-73.161	-1423.679
% 39.5811146	-79.2325574	-154.0184351	-13.756	-72.99	-1423.351
% 40.9025178	-79.0133685	-155.308467	-13.601	-73.003	-1423.166
% 42.5354419	-78.8084962	-156.9108052	-13.453	-72.843	-1422.951
% 44.1708307	-78.5969421	-158.5221655	-13.421	-72.827	-1422.674
% 45.1418769	-78.3457003	-159.4599121	-13.468	-72.688	-1422.388
% 46.5270371	-78.067941	-160.8145655	-13.503	-72.578	-1422.104
% 47.5346278	-77.8411074	-161.7789824	-13.438	-72.545	-1421.917
% 48.5363032	-77.625597	-162.7473716	-13.447	-72.533	-1421.644
% 49.6828554	-77.3134578	-163.8601553	-13.13	-72.312	-1421.431
% 50.6529828	-77.0302353	-164.8053784	-13.169	-72.361	-1421.166
% 51.781458	-76.7460822	-165.8981954	-13.34	-72.093	-1420.838
% 52.7178126	-76.5179526	-166.7973642	-13.303	-72.066	-1420.615
% 53.6853129	-76.2763945	-167.7359676	-13.262	-71.953	-1420.385
% 54.4541898	-75.940719	-168.476353	-13.031	-71.868	-1420.177
% 55.1896214	-75.6443253	-169.1781505	-12.991	-71.716	-1419.938
% 56.0498444	-75.3492308	-169.9998558	-13.015	-71.613	-1419.666
% 56.9477707	-75.0607072	-170.8691172	-13.059	-71.514	-1419.382
% 57.8558129	-74.7802638	-171.7474629	-13.035	-71.407	-1419.121
% 58.3004191	-74.5109522	-172.1671168	-12.907	-71.363	-1418.912
% 59.023363	-74.1594275	-172.8533204	-12.727	-71.264	-1418.66
% 59.8221219	-73.9185172	-173.617395	-12.827	-71.071	-1418.461
% 60.365745	-73.5951012	-174.1300306	-12.813	-70.973	-1418.215
% 60.9350101	-73.2866825	-174.6618362	-12.756	-70.772	-1417.982
% 61.5452581	-72.9788083	-175.2319178	-12.768	-70.778	-1417.687
% 62.2550516	-72.655594	-175.9225142	-12.764	-70.531	-1417.38
% 62.6917651	-72.3623125	-176.3289281	-12.605	-70.41	-1417.199
% 63.3675169	-72.0547877	-176.9646639	-12.646	-70.346	-1416.947
% 63.8204589	-71.7186876	-177.3938613	-12.681	-70.179	-1416.622
% 64.1581177	-71.3875723	-177.7021871	-12.5	-70.19	-1416.38
% 64.7469012	-71.064847	-178.2486183	-12.327	-69.819	-1416.274
% 65.1537113	-70.774545	-178.6304249	-12.42	-69.802	-1415.989
% 65.847558	-70.4620586	-179.2913438	-12.529	-69.667	-1415.679
% 66.1420928	-70.1503789	-179.5370014	-12.36	-69.472	-1415.522
% 66.6304161	-69.8436309	-179.9999127	-12.4	-69.499	-1415.26
% 67.0116546	-69.4890062	179.6484028	-12.255	-69.295	-1415.078
% 67.3263474	-69.1646741	179.3564906	-12.134	-69.153	-1414.792
% 67.6168504	-68.8460366	179.1055311	-11.953	-68.927	-1414.605
% 68.0782735	-68.5511522	178.6745309	-11.949	-68.943	-1414.398
% 68.4969034	-68.2344076	178.2850706	-12.032	-68.834	-1414.121
% 68.7370471	-67.8893752	178.0811975	-11.987	-68.676	-1413.831
% 69.1610529	-67.5901561	177.6966959	-11.962	-68.58	-1413.629
% 69.3622566	-67.2485934	177.5128989	-11.806	-68.342	-1413.465
% 69.8201704	-66.9436564	177.0968107	-11.917	-68.287	-1413.169
% 70.0313444	-66.5557063	176.9011252	-11.905	-68.056	-1412.917
% 70.4053675	-66.21051	176.5711202	-11.956	-67.832	-1412.73
% 70.6901002	-65.893317	176.3211165	-11.773	-67.743	-1412.457
% 71.0291332	-65.5511949	176.008088	-11.756	-67.575	-1412.197
% 71.3035411	-65.238908	175.7823641	-11.629	-67.493	-1412.029
% 71.5901559	-64.8353592	175.5230119	-11.605	-67.183	-1411.807
% 71.8343674	-64.5073404	175.3143806	-11.568	-67.057	-1411.547
% 72.1049503	-64.1846375	175.0719435	-11.685	-67.091	-1411.203
% 72.3390307	-63.8226465	174.870823	-11.592	-66.744	-1411.093
% 72.6013234	-63.5178006	174.6491485	-11.518	-66.582	-1410.936
% 72.852402	-63.1409059	174.4299838	-11.42	-66.404	-1410.668
% 73.0955472	-62.816096	174.2115703	-11.516	-66.468	-1410.307
% 73.3212122	-62.4901133	174.0282263	-11.263	-66.259	-1410.192
% 73.5422798	-62.1619129	173.8373467	-11.256	-65.852	-1410.097
% 73.6914577	-61.7932832	173.7165639	-11.25	-65.619	-1409.829
% 73.9643009	-61.4865127	173.4756815	-11.224	-65.699	-1409.568
% 74.1623926	-61.1605147	173.3131198	-11.093	-65.496	-1409.407
% 74.3843464	-60.7907406	173.1349799	-10.877	-65.326	-1409.251
% 74.6082038	-60.4613807	172.9149046	-11.14	-65.19	-1408.879
% 74.7892541	-60.1004037	172.7733661	-11.116	-64.921	-1408.676
% 74.9640307	-59.7978937	172.6497621	-10.893	-64.941	-1408.534
% 75.1354553	-59.4766669	172.5071632	-10.847	-64.545	-1408.418
% 75.3225271	-59.1035334	172.3288722	-10.892	-64.389	-1408.137
% 75.5631268	-58.7521123	172.139615	-10.908	-64.275	-1407.848
% 75.7482783	-58.4530751	171.9938357	-10.76	-64.029	-1407.782
% 75.8733178	-58.1424023	171.8783949	-10.611	-64.174	-1407.564
% 75.9791232	-57.9865459	171.7864167	-10.658	-64.258	-1407.41
% 75.9942463	-57.9850704	171.7817707	-10.631	-64.11	-1407.408
% 75.9489446	-57.9556067	171.8419482	-10.519	-63.596	-1407.575
% 75.9652776	-57.9688298	171.8306519	-10.485	-63.656	-1407.618
% 75.9372272	-57.9573113	171.8521667	-10.535	-63.861	-1407.497
% 75.9828015	-57.9411252	171.8025024	-10.585	-63.752	-1407.481
% 75.9583897	-57.940953	171.8264959	-10.619	-63.692	-1407.531
% 75.9556083	-57.9537574	171.8279477	-10.593	-63.879	-1407.509
% 75.8996905	-57.946713	171.885005	-10.581	-63.858	-1407.466
% 75.9995091	-57.9394139	171.7880832	-10.595	-63.692	-1407.51
% 75.9339977	-57.9373733	171.8507111	-10.599	-63.741	-1407.529
% 75.9503243	-57.9707606	171.8340099	-10.57	-63.837	-1407.512
% 75.9318222	-57.9401036	171.8517727	-10.567	-63.727	-1407.47
% 76.004062	-57.9609787	171.7830418	-10.6	-63.721	-1407.53
% 75.93972	-57.9499139	171.8464411	-10.581	-63.808	-1407.535
% 75.9707162	-57.9460154	171.8181495	-10.564	-63.785	-1407.481
% 75.9959807	-57.9421629	171.7892863	-10.585	-63.71	-1407.471
% 75.9249859	-57.9391939	171.8577538	-10.595	-63.766	-1407.52
% 75.9533937	-57.9507898	171.83664	-10.581	-63.804	-1407.499
% 75.9957699	-57.9443035	171.7956634	-10.569	-63.739	-1407.47
% 75.9396182	-57.9353904	171.8460752	-10.576	-63.736	-1407.496
% 75.9618882	-57.9625978	171.8247502	-10.585	-63.802	-1407.528
% 75.9715769	-57.9228999	171.8164104	-10.574	-63.757	-1407.47
% 75.9609828	-57.9491608	171.8279184	-10.581	-63.736	-1407.484
% 75.9943196	-57.9555329	171.7935891	-10.6	-63.773	-1407.523
% 75.9938296	-57.9417053	171.7944507	-10.597	-63.777	-1407.515
% 75.9098317	-57.9420311	171.8781908	-10.565	-63.744	-1407.486
% 75.976119	-57.9361899	171.8092321	-10.58	-63.748	-1407.497
% 75.9409166	-57.9557343	171.8451962	-10.576	-63.783	-1407.519
% 75.9382233	-57.9540166	171.8479365	-10.573	-63.759	-1407.508
% 75.9650661	-57.9482205	171.8240085	-10.577	-63.748	-1407.49
% 75.9524449	-57.9545098	171.8335753	-10.586	-63.777	-1407.509
% 75.9288689	-57.9547213	171.8569271	-10.596	-63.772	-1407.515
% 76.0010608	-57.9635296	171.7835776	-10.6	-63.754	-1407.501
% 75.9814562	-57.9369733	171.8069292	-10.597	-63.766	-1407.485
% 76.0079889	-57.9433657	171.779942	-10.6	-63.771	-1407.502
% 75.9603351	-57.9617357	171.827439	-10.588	-63.758	-1407.515
% 76.024638	-57.9499757	171.7659675	-10.583	-63.761	-1407.482
% 					
%     
% ];
% data = [13.0402169	-81.2853935	-127.9322908	-14.023	-74.06	-1426.874
% 25.7584105	-80.6529849	-140.4559064	-13.69	-73.667	-1425.427
% 42.5354419	-78.8084962	-156.9108052	-13.453	-72.843	-1422.951
% 53.6853129	-76.2763945	-167.7359676	-13.262	-71.953	-1420.385
% 60.9350101	-73.2866825	-174.6618362	-12.756	-70.772	-1417.982
% 66.1420928	-70.1503789	-179.5370014	-12.36	-69.472	-1415.522
% 69.8201704	-66.9436564	177.0968107	-11.917	-68.287	-1413.169
% 72.6013234	-63.5178006	174.6491485	-11.518	-66.582	-1410.936
% 74.7892541	-60.1004037	172.7733661	-11.116	-64.921	-1408.676
% 75.9652776	-57.9688298	171.8306519	-10.485	-63.656	-1407.618
% 76.004062	-57.9609787	171.7830418	-10.6	-63.721	-1407.53
% 
% 	];
% cube position
data=[
    0.3683    0.1678    0.2642   -6.1374  -10.0637  -14.2764
    0.4457    0.5261    0.1954    1.9777    4.6786   17.5639
    0.6676    0.4080    0.6682    0.0959    0.5852    3.3674
    0.0415    0.0604    0.3022  -43.3046   -3.3489   -8.3068
    0.6853    0.4050    0.7284    5.5020    8.1980    8.5526
    0.2710    0.2073    0.2251  -17.5356  -22.7308  -21.9462
    0.4353   -0.0499    0.5782   34.2563   10.7438   12.9861
    0.7720    0.1887    0.6025    6.8351   -0.1697   -2.0980
    0.3966    0.0520    0.2439  -16.6529  -11.4413  -41.4284
    0.4788    0.0580    0.7672  -10.6424    5.8249  -13.9306
    ];

[dataSizeA, dataSizeB] = size(data);
HalfDataSizeA = floor(dataSizeA/2);

%计算旋量
pointAndUaxis = zeros(HalfDataSizeA,8);
for i = 1:HalfDataSizeA
pointAndUaxis(i,:) = rot2sm(data(i,:), data(i+HalfDataSizeA,:));

end

%最小二乘法计算trocarPoint
points = pointAndUaxis(:,1:3);
vectors = pointAndUaxis(:,4:6);

left = zeros(3,3);
right = zeros(3,1);
for i = 1:size(points,1)
    p = points(i,:);
    v = vectors(i,:);
    % x偏导数为零
   left(1,1) = left(1,1) +1/v(1)-v(1);
   left(1,2) = left(1,2) -v(2);
   left(1,3) = left(1,3) -v(3);
   right(1,1) = right(1,1) + p(1)/v(1) - p(1) * v(1) - p(2)*v(2) - p(3)*v(3);
   % y偏导数为零
   left(2,1) = left(2,1) -v(1);
   left(2,2) = left(2,2) +1/v(2) -v(2);
   left(2,3) = left(2,3) -v(3);
   right(2,1) = right(2,1) + p(2)/v(2) - p(1) * v(1) - p(2)*v(2) - p(3)*v(3);
   % z偏导数为零
   left(3,1) = left(3,1) -v(1);
   left(3,2) = left(3,2) -v(2);
   left(3,3) = left(3,3) +1/v(3)-v(3);
   right(3,1) = right(3,1) + p(3)/v(3) - p(1) * v(1) - p(2)*v(2) - p(3)*v(3);
   
end

%三元一次方程计算
trocarPoint = left\right;
%计算trocarPoint到各个旋量轴距离，求平均值
trocarPointDistance = zeros(HalfDataSizeA, 1);
for i = 1: HalfDataSizeA
trocarPointDistance(i,1) = calcpointDistanceToLine(trocarPoint' , points(i,:),vectors(i,:));

end

trocarPointError = mean(trocarPointDistance);

% 欧拉角转为旋转矩阵加上平移
function T = rot2t(data)
    
zyx = data(1:3);
% zyx = zyx/180*pi;
t = data(4:6);
t= t';

R = eul2rotm(zyx,'zyx');

T = [R,t;0 0 0 1];
end
%求两个位姿的旋量
function sm = rot2sm(data1, data2)

T1 = rot2t(data1);
T2 = rot2t(data2);
T = T1*InvertT(T2);
twist = logT(T);
plot_twist(twist);
sm = twist2sm(twist);
end

%trocar 点到旋量轴的距离
function d = calcpointDistanceToLine(point, linePoint,lineVector)
    p2p = point -linePoint;
    tmp = cross(p2p, lineVector);
    d = norm(tmp);
   
end